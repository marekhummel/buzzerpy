<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.5/socket.io.js"></script>
    <script src="{{url_for('static', filename='scripts.js')}}?"></script>
    <script src="{{url_for('static', filename='stopwatch.js')}}?"></script>

    <script src="../static/scripts.js"></script>
    <script type="text/javascript" charset="utf-8">       
        var socket = io();
        var buzzer_clicked = false;
        var name = "{{ playername }}";
        var closing_timer;

        // Connect and disconnect player
        window.onload = function () {
            socket.emit('game_joined', { playername: name });             
        };

        window.onbeforeunload = function () {
            socket.emit('game_left', { playername: name });
        };


        // Game update
        socket.on('player_update', function (players, current_player) {
            var new_ul = create_player_list(players, current_player, "playerlist", false);
            document.getElementById("playerlist").replaceWith(new_ul);

            var new_table = create_scoreboard(players, "scoreboard");
            document.getElementById("scoreboard").replaceWith(new_table);
        }); 

        socket.on('host_update', function (host) {
            if (host === undefined) {
                var closing_counter = 30;
                closing_timer = setInterval(function () {
                    closing_counter--;
                    document.getElementById("hostname").innerText = `Your host has left, game will be closed in ${closing_counter}secs`;
                    if (closing_counter == 0) {
                        clearInterval(closing_timer);
                        window.location.href = '/';
                    }
                }, 1000);
            }
            else {
                clearInterval(closing_timer);
                document.getElementById("hostname").innerText = 'Hosted by "' + host.name + '"';
            }

        });

        socket.on('disconnect', function () {
            window.location.href = '/';
        });

        // Game features
        socket.on('player_buzzer_reset', function () {
            buzzer_clicked = false;
            document.getElementById("buzzer").setAttribute("fill", "#d9534f");
            document.getElementById("buzzed").innerHTML = "BUZZ";
        });

        socket.on('player_kicked', function (kicked) {
            if (kicked == name)
                window.location.href = '/';
        });


        socket.on('stopwatch_action', function (action) {
            switch (action) {
                case 'start': 
                    stopwatch_start();
                    break;
                case 'stop': 
                    stopwatch_stop();
                    break;
                case 'reset': 
                    stopwatch_reset();
                    break;
            };
        })

        // Locals
        function send_click() {
            if (!buzzer_clicked) {
                socket.emit('buzzer_clicked', { playername: name });
                buzzer_clicked = true;
                document.getElementById("buzzer").setAttribute("fill", "#5cb85c");
                document.getElementById("buzzed").innerHTML = "BUZZED";
            };
        };

        document.addEventListener('keydown', function (event) {
            if (event.keyCode == 32) // Space
                send_click();
        });
    </script>
</head>

<body class="bg-light">
    <div class="container-fluid">
        <div class="row mt-3">
            <div class="col-xl">
                <h1 class="text-center">Joined Game as "{{ playername }}"</h1>
            </div>
        </div>
        <div class="row mb-5">
            <div class="col-xl">
                <h3 class="text-center" id="hostname">Hosted by "{{ hostname }}"</h3>
            </div>
        </div>

        <div class="row align-items-center" style="min-height: 60vh;">
            <div class="col-xl-4 mx-auto">
                <div id="playerlist"></div>
            </div>

            <div class="col-xl-4 mb-5">
                <svg style="display: block; margin: auto;" viewBox="0 0 100 100" width="80%">
                    <g>
                        <circle id="buzzer" class="p-3 bg-danger text-white" onclick='send_click()' cx="50" cy="50" r="45" stroke="black" stroke-width="1" fill="#d9534f"/>
                        <text id="buzzed" style="pointer-events: none;" x="50%" y="50%" font-size="100%" dominant-baseline="middle" text-anchor="middle">BUZZ</text>
                    </g>
                </svg>
            </div>
    
            <div class="col-xl-4">
                <div class="card bg-light mb-5 mx-auto" style="width: 80%;">
                    <div class="card-body">
                        <h3 class="card-title text-center fw-bold">Scoreboard</h5>
                            <table class="table table-sm card-text mt-4">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">&check;</th>
                                        <th scope="col">&cross;</th>
                                        <th scope="col">&starf;</th>
                                        <th scope="col">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="scoreboard"></tbody>
                            </table>
                    </div>
                </div>


                <div class="card bg-light mx-auto" style="width: 80%;">
                    <svg class="card-img-top">
                        <g>
                            <rect width="100%" height="100%" fill="lightgray" />
                            <text id="stopwatch" x="50%" y="50%" font-size="250%" dominant-baseline="middle"
                                text-anchor="middle">00:00:00</text>
                        </g>
                    </svg>
                    <div class="card-body">
                        <h5 class="card-title">Stopwatch</h5>
                        <p class="card-text">Stopwatch to get buzzer times</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-grid col-2 mx-auto my-3">
        <button id="button_leave" class="btn btn-danger" type="button" style="width: 100%;" onclick="window.location.href = '/'">Leave Game</button>
    </div>

</body>

</html>